name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Check code formatting
      run: |
        uv run black --check --diff llm_json_streaming tests

    - name: Check import sorting
      run: |
        uv run isort --check-only --diff llm_json_streaming tests

    - name: Type checking
      run: |
        uv run mypy llm_json_streaming

    - name: Lint code
      run: |
        uv run ruff check llm_json_streaming tests

    - name: Security scan
      run: |
        uv run bandit -r llm_json_streaming/

    - name: Check dependencies
      run: |
        uv run safety check

  doc-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install markdown-link-check

    - name: Check README links
      run: |
        markdown-link-check README.md --verbose

    - name: Check API documentation links
      run: |
        markdown-link-check API_REFERENCE.md --verbose || true

    - name: Validate CHANGELOG format
      run: |
        if [ -f CHANGELOG.md ]; then
          # Check if CHANGELOG follows Keep a Changelog format
          if grep -q "## \[" CHANGELOG.md; then
            echo "✅ CHANGELOG format is valid"
          else
            echo "❌ CHANGELOG format is invalid"
            exit 1
          fi
        else
          echo "⚠️ CHANGELOG.md not found"
        fi